---
phase: 05-selection-and-free-text-modes
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - emacs/ask-user-popup.el
autonomous: true

must_haves:
  truths:
    - "User sees text input field below options list"
    - "User can type custom response in text field"
    - "User can switch between options and text field with Tab"
    - "C-c C-c submits text content"
    - "RET in text field submits single-line response"
    - "User can enter multi-line text with Shift+RET"
  artifacts:
    - path: "emacs/ask-user-popup.el"
      provides: "Free-text input mode below options"
      contains: "defun ask-user-popup--submit-text"
  key_links:
    - from: "ask-user-popup-mode-map"
      to: "ask-user-popup--focus-text"
      via: "Tab keybinding"
      pattern: 'define-key.*TAB'
    - from: "ask-user-popup--submit-text"
      to: "exit-recursive-edit"
      via: "text submission"
      pattern: "exit-recursive-edit"
---

<objective>
Add free-text input mode: text field below options for custom responses, Tab switching between options and text, multi-line support, and proper submission behavior.

Purpose: Users can type custom responses when predefined options don't fit, while still having quick access to suggested options
Output: Updated ask-user-popup.el with integrated free-text mode
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-selection-and-free-text-modes/05-CONTEXT.md
@.planning/phases/05-selection-and-free-text-modes/05-01-SUMMARY.md
@emacs/ask-user-popup.el
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add text input field rendering and focus management</name>
  <files>emacs/ask-user-popup.el</files>
  <action>
Add text input area rendering (always shown, below options):

After options list (or after separator if no options), add:
- Visual separator: small gap or thin line
- Label: "Or type a response:" (muted text)
- Editable text region using an overlay with `'field` property

Buffer-local variables for text mode:
- `ask-user-popup--text-start`: marker for start of editable region
- `ask-user-popup--text-end`: marker for end of editable region
- `ask-user-popup--focus`: symbol 'options or 'text indicating current focus

Implementation approach for editable region:
- Use `inhibit-read-only` when creating the region
- Set text properties to make region editable while rest is read-only
- Or use overlay with `modification-hooks` to allow editing

Focus management:
- `ask-user-popup--focus-options`: Move point to options, restore selection highlight
- `ask-user-popup--focus-text`: Move point into text field, dim selection highlight
- Track focus state in `ask-user-popup--focus`

Keybinding for Tab:
- When focus is 'options: call `ask-user-popup--focus-text`
- When focus is 'text: call `ask-user-popup--focus-options`

CONTEXT.md decision: C-n past last option enters text field, C-p from text field jumps to last option
- Modify `ask-user-popup--select-next` to enter text field when on last option
- Modify text field to respond to C-p by jumping to last option
  </action>
  <verify>
Test manually:
```elisp
(mr-x/ask-user-popup "Choose color" "Pick your favorite" '("Red" "Green" "Blue"))
```

1. Popup shows options AND text field below
2. First option is highlighted (focus on options)
3. Press Tab - cursor moves to text field, option highlight dims
4. Press Tab - cursor returns to options, highlight restored
5. C-n on "Blue" (last option) - moves to text field
6. C-p in text field - jumps to "Blue" (last option)
  </verify>
  <done>Text field appears below options, Tab switches focus, C-n/C-p flow naturally between options and text</done>
</task>

<task type="auto">
  <name>Task 2: Implement text editing and submission</name>
  <files>emacs/ask-user-popup.el</files>
  <action>
Text editing behavior:
- When focus is 'text, allow typing in the editable region
- Self-insert-command should work in text region
- Backspace/delete work normally

Multi-line support (CONTEXT.md: auto-expand, Shift+RET for newlines):
- Shift+RET or C-j: insert newline, expand text field visually
- RET alone: submit text (quick single-line)

Submission functions:

`ask-user-popup--submit-text`:
- Extract text content from editable region
- Trim whitespace
- If empty and options exist, confirm current option instead
- If non-empty, store in ask-user-popup--result
- Call exit-recursive-edit

`ask-user-popup--insert-newline`:
- Insert newline at point in text field
- Auto-resize if needed

Keybindings when focus is 'text:
- C-c C-c: ask-user-popup--submit-text (always works)
- RET: ask-user-popup--submit-text (quick submit)
- S-RET or C-j: ask-user-popup--insert-newline

CONTEXT.md decision: "Selecting an option discards any typed text (option wins)"
- When `ask-user-popup--confirm-selection` is called, ignore text content

Pure text mode (no options):
- If OPTIONS is nil, only show text field
- Skip options rendering entirely
- All submission keys work the same
  </action>
  <verify>
Test with options:
```elisp
(mr-x/ask-user-popup "Choose color" "Pick your favorite" '("Red" "Green" "Blue"))
```
1. Tab to text field
2. Type "Purple"
3. Press RET - returns "Purple"

Test multi-line:
```elisp
(mr-x/ask-user-popup "Describe issue" "Be detailed" nil)
```
1. Type "Line one"
2. Press C-j or S-RET
3. Type "Line two"
4. Press C-c C-c - returns "Line one\nLine two"

Test option wins:
1. Tab to text, type "custom"
2. Tab back to options, RET on "Red"
3. Returns "Red" (not "custom")
  </verify>
  <done>Text field accepts input, RET submits single line, C-c C-c submits multi-line, C-j adds newlines</done>
</task>

<task type="auto">
  <name>Task 3: Verify combined mode end-to-end via emacsclient</name>
  <files>emacs/ask-user-popup.el</files>
  <action>
Test complete flow through emacsclient:

Test 1 - Options with text fallback:
```bash
emacsclient --eval '(mr-x/ask-user-popup "Choose color" "Pick your favorite" (quote ("Red" "Green" "Blue")))'
```
- Navigate to text field
- Type "Purple"
- Press RET
- Verify returns: `"Purple"`

Test 2 - Option selection ignores text:
```bash
emacsclient --eval '(mr-x/ask-user-popup "Choose" nil (quote ("A" "B")))'
```
- Type "custom" in text field
- Tab to options, RET on "B"
- Verify returns: `"B"`

Test 3 - Pure text mode (no options):
```bash
emacsclient --eval '(mr-x/ask-user-popup "Describe issue" "Be detailed" nil)'
```
- Type response
- C-c C-c
- Verify returns typed text

Test 4 - Multi-line text:
- Type "Line 1"
- C-j
- Type "Line 2"
- C-c C-c
- Verify returns text with newline preserved

Test 5 - Cancel behavior still works:
- C-g at any point
- Verify non-zero exit from emacsclient

Fix any issues before marking complete.
  </action>
  <verify>
All test cases pass:
- Options + custom text works
- Option selection overrides text
- Pure text mode works
- Multi-line preserved
- Cancel still works
  </verify>
  <done>Both selection and free-text modes work seamlessly, with proper mode switching and submission behavior</done>
</task>

</tasks>

<verification>
1. Text field appears below options (when options exist)
2. Text field is sole UI when no options provided
3. Tab switches focus between options and text
4. C-n from last option enters text, C-p from text enters options
5. User can type and edit in text field
6. RET submits text, C-c C-c also submits
7. C-j/S-RET inserts newline for multi-line
8. Selecting option ignores typed text
9. Works via emacsclient
</verification>

<success_criteria>
- Both interaction modes coexist in single popup
- Mode switching is fluid (Tab, C-n, C-p)
- Text submission works (RET, C-c C-c)
- Multi-line text supported (C-j)
- Option selection takes precedence over text
- Pure text mode works when no options
</success_criteria>

<output>
After completion, create `.planning/phases/05-selection-and-free-text-modes/05-02-SUMMARY.md`
</output>
