---
phase: 05-selection-and-free-text-modes
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/index.ts
  - src/emacs-interface.ts
autonomous: false

must_haves:
  truths:
    - "MCP tool accepts options array parameter"
    - "Node.js passes options to emacsclient"
    - "Popup displays options from MCP call"
    - "Return value properly escaped for MCP response"
    - "Timeout still works with popup UI"
    - "Falls back to v1 minibuffer if popup unavailable"
  artifacts:
    - path: "src/index.ts"
      provides: "options parameter in tool schema"
      contains: "options: z.array"
    - path: "src/emacs-interface.ts"
      provides: "Options array passing to emacsclient"
      contains: "optionsArg"
  key_links:
    - from: "src/index.ts"
      to: "askViaEmacs"
      via: "options parameter forwarding"
      pattern: "options:"
    - from: "src/emacs-interface.ts"
      to: "mr-x/ask-user-popup"
      via: "elisp expression with options"
      pattern: "mr-x/ask-user-popup.*options"
---

<objective>
Wire the Node.js MCP server to pass options array to the Elisp popup function, ensuring proper escaping, fallback behavior, and timeout handling.

Purpose: Claude can provide options for users to choose from, completing the end-to-end flow
Output: Updated TypeScript files with options support in MCP tool
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-selection-and-free-text-modes/05-CONTEXT.md
@.planning/phases/05-selection-and-free-text-modes/05-02-SUMMARY.md
@src/index.ts
@src/emacs-interface.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add options parameter to MCP tool schema and interface</name>
  <files>src/index.ts, src/emacs-interface.ts</files>
  <action>
Update src/index.ts:
- Add `options` to inputSchema:
```typescript
options: z
  .array(z.string())
  .optional()
  .describe("Optional list of choices for the user to select from"),
```
- Pass options to askViaEmacs call:
```typescript
const response = await askViaEmacs(args.question, {
  header: args.header,
  timeout_ms: args.timeout_ms,
  options: args.options,
});
```

Update src/emacs-interface.ts:
- Add `options` to AskOptions interface:
```typescript
export interface AskOptions {
  header?: string;
  timeout_ms?: number;
  options?: string[];
}
```

- Create options array escaping function:
```typescript
function formatElispList(items: string[]): string {
  const escaped = items.map(s => `"${escapeElispString(s)}"`).join(' ');
  return `(list ${escaped})`;
}
```

- Build optionsArg for elisp:
```typescript
const optionsArg = options.options?.length
  ? formatElispList(options.options)
  : "nil";
```

- Update elisp expression to pass options as third argument:
```typescript
(mr-x/ask-user-popup "${escapedQuestion}" ${descriptionArg} ${optionsArg})
```

Fallback chain update:
- v1 minibuffer (mr-x/ask-user-question) doesn't support options - that's OK
- When falling back to v1, options are ignored (user gets basic prompt)
- read-string fallback also ignores options
- Add comment explaining this is expected degradation

Ensure npm run build succeeds.
  </action>
  <verify>
1. `npm run build` compiles without errors
2. `grep "options: z.array" build/index.js` shows schema
3. `grep "formatElispList\|optionsArg" build/emacs-interface.js` shows handling
4. Review generated elisp in build output to confirm options passed correctly
  </verify>
  <done>MCP tool schema includes options array, TypeScript types updated, elisp expression passes options</done>
</task>

<task type="auto">
  <name>Task 2: Verify options flow and return value escaping</name>
  <files>src/emacs-interface.ts</files>
  <action>
Test the complete flow:

1. Build and review generated elisp:
```bash
npm run build
```

2. Examine generated code for proper quoting:
- Options should be: `(list "Option 1" "Option 2")`
- Special characters in options should be escaped
- nil when no options

3. Verify return value handling:
- Existing code strips quotes: `result.slice(1, -1)`
- This works for both option selection and typed text
- Newlines in multi-line text should be preserved

4. Test escaping edge cases by examining code:
- Option with quote: "Say \"hello\"" -> properly escaped
- Option with backslash: "C:\\path" -> properly escaped
- Unicode should pass through

5. Verify timeout handling:
- The timeout mechanism is unchanged (manual timer)
- popup's recursive-edit blocks until response or cancel
- Timeout kills emacsclient process regardless of UI mode

If any escaping issues found, fix in escapeElispString or formatElispList.
  </action>
  <verify>
- Elisp list syntax is valid
- Special characters properly escaped
- Return value parsing handles all cases
- Timeout mechanism unchanged
  </verify>
  <done>Options properly formatted as elisp list, return values properly escaped for MCP response</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete integration: MCP tool with options parameter, Node.js passing options to emacsclient, Elisp popup displaying and handling options/text.
  </what-built>
  <how-to-verify>
1. Reload ask-user.el and ask-user-popup.el in Emacs:
   ```elisp
   (load-file "emacs/ask-user.el")
   ```

2. Restart MCP server or reload configuration

3. Ask Claude to use the AskUserQuestion tool with options. For example:
   "What is your preferred programming language? Options: Python, JavaScript, TypeScript, Go, Rust"

4. Verify:
   - Popup appears with numbered options
   - Can navigate with C-n/C-p
   - Can select with RET
   - Can type custom response
   - Response returns to Claude

5. Test timeout by not responding for a while (or use short timeout in direct test)

6. Test fallback: temporarily rename mr-x/ask-user-popup, verify v1 minibuffer used
  </how-to-verify>
  <resume-signal>Type "verified" if integration works, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. MCP tool schema accepts options array
2. TypeScript compiles without errors
3. Options passed to emacsclient as valid elisp list
4. Popup displays options from Claude's request
5. Selected option or typed text returned to Claude
6. Special characters in options escaped properly
7. Timeout mechanism still works
8. Graceful fallback when popup unavailable
</verification>

<success_criteria>
- Claude can specify options in AskUserQuestion calls
- User sees options in popup
- User selection or typed response returns to Claude
- Timeout and fallback behavior preserved
- End-to-end integration verified by user
</success_criteria>

<output>
After completion, create `.planning/phases/05-selection-and-free-text-modes/05-03-SUMMARY.md`
</output>
