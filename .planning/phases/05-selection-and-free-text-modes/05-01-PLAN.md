---
phase: 05-selection-and-free-text-modes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - emacs/ask-user-popup.el
autonomous: true

must_haves:
  truths:
    - "User sees numbered list of options in popup"
    - "User can navigate between options with C-n/C-p"
    - "Selected option is visually highlighted (inverse colors)"
    - "RET on highlighted option returns that option text"
    - "Navigation wraps around at list ends"
  artifacts:
    - path: "emacs/ask-user-popup.el"
      provides: "Selection mode with navigation and highlighting"
      contains: "defun ask-user-popup--select-next"
  key_links:
    - from: "ask-user-popup-mode-map"
      to: "ask-user-popup--select-next"
      via: "keybinding C-n"
      pattern: 'define-key.*C-n.*select-next'
    - from: "ask-user-popup--confirm-selection"
      to: "exit-recursive-edit"
      via: "selection confirmation"
      pattern: "exit-recursive-edit"
---

<objective>
Implement selection mode for the popup buffer: display options as numbered list, add C-n/C-p navigation with highlighted selection, and return selected option on RET.

Purpose: Users can visually navigate and choose from Claude's suggested options using familiar Emacs keys
Output: Updated ask-user-popup.el with selection mode functionality
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-selection-and-free-text-modes/05-CONTEXT.md
@emacs/ask-user-popup.el
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add options rendering with numbered list display</name>
  <files>emacs/ask-user-popup.el</files>
  <action>
Update mr-x/ask-user-popup function signature to accept OPTIONS parameter:
- Signature: `(defun mr-x/ask-user-popup (question &optional description options))`
- OPTIONS is a list of strings representing choices

Add options rendering in the buffer setup:
- After the separator line, if OPTIONS is non-nil:
  - Iterate over options with index
  - Insert each as: `N. Option text\n` where N is 1-indexed
  - Each option line gets text property `option-index` set to its 0-indexed position
  - Leave one blank line after last option

Add buffer-local variables:
- `ask-user-popup--options`: stores the options list
- `ask-user-popup--selected-index`: stores current selection (0-indexed), default 0

Create selection overlay:
- `ask-user-popup--selection-overlay`: overlay for highlighting current selection
- Face: use `(:inverse-video t)` for classic Emacs selection look

When buffer is created with options:
- Store options in buffer-local var
- Set selected-index to 0
- Create overlay spanning first option line
- Apply inverse-video face to overlay

Do NOT add navigation keys yet (that's Task 2).
  </action>
  <verify>
Test manually in Emacs:
```elisp
(mr-x/ask-user-popup "Choose color" "Pick your favorite" '("Red" "Green" "Blue"))
```
Should display popup with:
```
Choose color (bold)
Pick your favorite (muted)
────────────────────────────────────────

1. Red      <- highlighted with inverse colors
2. Green
3. Blue
```
  </verify>
  <done>Options display as numbered list with first option highlighted via inverse-video overlay</done>
</task>

<task type="auto">
  <name>Task 2: Add navigation and selection keybindings</name>
  <files>emacs/ask-user-popup.el</files>
  <action>
Create navigation functions:

`ask-user-popup--select-next`:
- Increment selected-index (mod number of options for wrap-around)
- Move overlay to new selection
- Silent operation (no message)

`ask-user-popup--select-prev`:
- Decrement selected-index (mod number of options for wrap-around)
- Move overlay to new selection
- Silent operation (no message)

`ask-user-popup--move-selection-overlay`:
- Find the line with matching option-index text property
- Move overlay start/end to span that line (including newline)
- Use `goto-char` to position point at line start

`ask-user-popup--confirm-selection`:
- Get option text at current selected-index
- Store in ask-user-popup--result
- Call exit-recursive-edit

`ask-user-popup--select-option-at-point`:
- Used for mouse click support
- Get option-index property at point
- If valid, set selected-index and confirm immediately

Update ask-user-popup-mode-map (only when options exist):
- C-n and down-arrow: ask-user-popup--select-next
- C-p and up-arrow: ask-user-popup--select-prev
- j: ask-user-popup--select-next (vim/evil friendly)
- k: ask-user-popup--select-prev (vim/evil friendly)
- RET: ask-user-popup--confirm-selection
- Mouse-1 on option: ask-user-popup--select-option-at-point

Implementation note: Since keymap is mode-level, check if options exist in command functions and do nothing if no options. Or use a conditional keymap binding approach.
  </action>
  <verify>
Test manually in Emacs:
```elisp
(mr-x/ask-user-popup "Choose color" "Pick your favorite" '("Red" "Green" "Blue"))
```
1. Press C-n - highlight moves to "2. Green"
2. Press C-n - highlight moves to "3. Blue"
3. Press C-n - highlight wraps to "1. Red"
4. Press C-p - highlight moves to "3. Blue"
5. Press j/k - navigation works
6. Press RET - popup closes, function returns selected option text
7. Click on option - confirms immediately
  </verify>
  <done>C-n/C-p navigate between options with visual feedback, RET confirms selection and returns option text</done>
</task>

<task type="auto">
  <name>Task 3: Verify selection mode end-to-end via emacsclient</name>
  <files>emacs/ask-user-popup.el</files>
  <action>
Test the selection mode works through emacsclient (simulating MCP server call):

1. Ensure ask-user.el is loaded in running Emacs
2. Run from terminal:
```bash
emacsclient --eval '(mr-x/ask-user-popup "Choose color" "Pick your favorite" (quote ("Red" "Green" "Blue")))'
```

3. In Emacs:
   - Verify popup appears with 3 numbered options
   - Navigate with C-n/C-p
   - Press RET on "Green"

4. Verify terminal shows: `"Green"` (the selected option, quoted)

5. Test cancel behavior:
```bash
emacsclient --eval '(mr-x/ask-user-popup "Choose" nil (quote ("A" "B")))'
```
   - Press C-g or q
   - Verify non-zero exit code from emacsclient

6. Test wrap-around navigation in both directions

If any issues found, fix in ask-user-popup.el before marking complete.
  </action>
  <verify>
- emacsclient returns the selected option text (e.g., "Green")
- Navigation and selection work as expected
- Cancel (C-g/q) causes emacsclient non-zero exit
  </verify>
  <done>Selection mode works end-to-end: emacsclient call displays options, user navigates and selects, selected option returned to caller</done>
</task>

</tasks>

<verification>
1. Popup displays numbered options list when options provided
2. First option highlighted on open
3. C-n/C-p/j/k/arrows navigate between options
4. Navigation wraps at ends (C-n on last -> first)
5. RET returns selected option text
6. C-g/q cancels and signals error
7. Works via emacsclient (MCP server path)
</verification>

<success_criteria>
- User can see numbered options in popup
- User can navigate with C-n/C-p and see highlight move
- User can confirm with RET and get option returned
- All navigation keys work (C-n, C-p, j, k, up, down)
- Selection wraps around at list ends
- Cancel still works (C-g, q)
</success_criteria>

<output>
After completion, create `.planning/phases/05-selection-and-free-text-modes/05-01-SUMMARY.md`
</output>
