---
phase: 03-emacs-ux-production-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - emacs/ask-user.el
  - src/emacs-interface.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Questions display with styled prefix (Claude asks:) visually distinct from plain prompts"
    - "If mr-x/ask-user-question is undefined, fallback to read-string works silently"
    - "Header parameter shows as (Header) in prompt when provided"
  artifacts:
    - path: "emacs/ask-user.el"
      provides: "mr-x/ask-user-question with propertize styling"
      contains: "propertize"
    - path: "src/emacs-interface.ts"
      provides: "Fallback-safe elisp code with condition-case"
      contains: "condition-case"
  key_links:
    - from: "src/emacs-interface.ts"
      to: "emacs/ask-user.el"
      via: "emacsclient --eval calling mr-x/ask-user-question"
      pattern: "mr-x/ask-user-question"
---

<objective>
Implement styled Emacs prompts with graceful fallback

Purpose: Make Claude's questions visually distinct in the minibuffer with bold styling, and ensure the server degrades gracefully if the custom elisp function isn't loaded.

Output: Updated `emacs/ask-user.el` with styled prompts and `src/emacs-interface.ts` with condition-case fallback.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-emacs-ux-production-hardening/03-RESEARCH.md
@emacs/ask-user.el
@src/emacs-interface.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update emacs/ask-user.el with styled mr-x/ask-user-question</name>
  <files>emacs/ask-user.el</files>
  <action>
Replace the current `ask-user-question` function with `mr-x/ask-user-question` that uses `propertize` for styling:

1. Rename function to `mr-x/ask-user-question` (namespaced)
2. Accept three parameters: `question`, optional `header`, optional `timeout-ms`
3. Build styled prompt:
   - If header provided: `(propertize (format "Claude asks (%s): " header) 'face 'bold)` 
   - If no header: `(propertize "Claude asks: " 'face 'bold)`
   - Question text: `(propertize question 'face 'minibuffer-prompt)`
   - Concat with space at end for cursor separation
4. Use `read-string` (not `read-from-minibuffer`) for simpler API
5. Keep the old `ask-user-question` as an alias pointing to `mr-x/ask-user-question` for backwards compatibility

Use standard Emacs faces (`bold`, `minibuffer-prompt`) that adapt to user themes.
  </action>
  <verify>
Test in Emacs:
1. `(load-file "emacs/ask-user.el")`
2. `(mr-x/ask-user-question "What is your name?")` — should show bold "Claude asks:" prefix
3. `(mr-x/ask-user-question "Pick color" "Color")` — should show bold "Claude asks (Color):"
4. `(ask-user-question "Legacy call")` — should work via alias
  </verify>
  <done>mr-x/ask-user-question displays styled prompts with bold prefix, adapts to header parameter, and backwards-compatible alias works</done>
</task>

<task type="auto">
  <name>Task 2: Update emacs-interface.ts with fallback-safe elisp</name>
  <files>src/emacs-interface.ts</files>
  <action>
Update `askViaEmacs` to use fallback-safe elisp with `condition-case`:

1. Change the elisp expression to:
   ```elisp
   (condition-case err
       (mr-x/ask-user-question "question" "header-or-nil")
     (void-function
      (progn
        (message "ask-user-mcp: mr-x/ask-user-question not defined, using read-string")
        (read-string "Claude asks: question "))))
   ```

2. For the header parameter:
   - If header provided: pass as string `"${escapedHeader}"`
   - If no header: pass `nil` (not `"nil"` string)

3. The `message` call logs a warning to Emacs *Messages* buffer (visible in logs but silent to user minibuffer experience)

4. Update the prompt format in fallback to match: `"Claude asks: ${question} "`

5. Keep all existing timeout, error classification, and logging logic unchanged

Important: The elisp string must properly escape embedded quotes and handle nil vs string for header.
  </action>
  <verify>
1. `npm run build` — compiles without errors
2. Test with function defined: Server uses styled prompt
3. Test with function undefined (fresh Emacs): Falls back to read-string, logs warning to *Messages*
4. Verify existing tests still pass if any
  </verify>
  <done>emacs-interface.ts uses condition-case for graceful fallback, styled function called when available, read-string fallback when not</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Load elisp and test styled prompts manually in Emacs
3. Test fallback by not loading elisp and calling tool
4. Verify *Messages* buffer shows warning on fallback
</verification>

<success_criteria>
- Questions display "Claude asks:" or "Claude asks (Header):" with bold styling
- If mr-x/ask-user-question undefined, fallback works transparently
- Warning logged to Emacs *Messages* on fallback (not blocking user)
- Build compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-emacs-ux-production-hardening/03-01-SUMMARY.md`
</output>
