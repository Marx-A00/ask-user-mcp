---
phase: 03-emacs-ux-production-hardening
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/emacs-interface.ts
  - README.md
  - TROUBLESHOOTING.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Q&A interactions logged with debug level (question, response, duration, success/error)"
    - "README enables self-service setup without assistance"
    - "Troubleshooting guide covers Emacs server down, socket issues, function not defined"
  artifacts:
    - path: "src/emacs-interface.ts"
      provides: "Q&A audit logging with Pino child logger"
      contains: "logger.child"
    - path: "README.md"
      provides: "Setup instructions with agent-shell JSON config"
      contains: "mcp-servers"
    - path: "TROUBLESHOOTING.md"
      provides: "Debugging guide for common failures"
      contains: "server-start"
  key_links:
    - from: "README.md"
      to: "emacs/ask-user.el"
      via: "load-file path reference"
      pattern: "load-file"
    - from: "src/emacs-interface.ts"
      to: "src/logger.ts"
      via: "child logger creation"
      pattern: "logger.child"
---

<objective>
Add Q&A audit logging and create documentation

Purpose: Enable debugging Q&A interactions via structured logs and provide self-service documentation for setup and troubleshooting.

Output: Q&A audit logging in emacs-interface.ts, complete README.md, and TROUBLESHOOTING.md guide.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-emacs-ux-production-hardening/03-RESEARCH.md
@.planning/phases/03-emacs-ux-production-hardening/03-CONTEXT.md
@.planning/phases/03-emacs-ux-production-hardening/03-01-SUMMARY.md
@src/emacs-interface.ts
@src/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Q&A audit logging to emacs-interface.ts</name>
  <files>src/emacs-interface.ts</files>
  <action>
Add structured Q&A audit logging using Pino child loggers:

1. At the start of `askViaEmacs`, create a child logger:
   ```typescript
   const startTime = Date.now();
   const qaLogger = logger.child({
     component: 'ask-user',
     question: question.slice(0, 100), // truncate for logs
     header: options.header,
     timeout_ms: timeout,
   });
   ```

2. Log Q&A initiation at debug level:
   ```typescript
   qaLogger.debug('Q&A initiated');
   ```

3. On success, log completion with response info:
   ```typescript
   qaLogger.debug({
     response: result.slice(0, 100), // truncate
     duration_ms: Date.now() - startTime,
     success: true,
   }, 'Q&A completed');
   ```

4. On error (in catch/reject), log failure:
   ```typescript
   qaLogger.debug({
     error: errorMsg,
     duration_ms: Date.now() - startTime,
     success: false,
   }, 'Q&A failed');
   ```

5. Replace existing debug/error logs in askViaEmacs with qaLogger calls to maintain consistency. Keep the error-level logs for actual errors but use qaLogger for context.

Use debug level for Q&A audit trail (only visible when LOG_LEVEL=debug).
  </action>
  <verify>
1. `npm run build` — compiles
2. Set `LOG_LEVEL=debug` and run server, Q&A events appear in logs
3. Verify log format includes question, response (truncated), duration, success flag
  </verify>
  <done>Q&A interactions logged at debug level with question, response, duration, and success/error status</done>
</task>

<task type="auto">
  <name>Task 2: Create README.md with setup instructions</name>
  <files>README.md</files>
  <action>
Create comprehensive README with:

1. **Header**: Project name + one-line description

2. **Quick Start** section:
   - Build commands: `npm install && npm run build`
   - Location of built files

3. **agent-shell Configuration** section:
   - JSON config example for `~/.config/agent-shell/mcp-servers.json`
   - Use `/REPLACE/WITH/ABSOLUTE/PATH/` placeholder (user must replace)
   - Example:
     ```json
     {
       "mcpServers": {
         "ask-user": {
           "command": "node",
           "args": ["/REPLACE/WITH/ABSOLUTE/PATH/ask-user-mcp/build/index.js"]
         }
       }
     }
     ```

4. **Emacs Setup** section:
   - use-package style config snippet
   - Include load-file for ask-user.el
   - Include server-start if not already running
   - Example:
     ```elisp
     ;; ask-user-mcp support
     (load-file "/REPLACE/WITH/ABSOLUTE/PATH/ask-user-mcp/emacs/ask-user.el")
     
     ;; Ensure Emacs server is running (required for emacsclient)
     (unless (server-running-p)
       (server-start))
     ```

5. **Tool Parameters** section:
   - `question` (required): The question to ask
   - `header` (optional): Context shown in prompt
   - `timeout_ms` (optional): Timeout 30s-30min, default 5min

6. **Debugging** section:
   - How to enable debug logs: `LOG_LEVEL=debug`
   - Link to TROUBLESHOOTING.md

Keep it minimal — just enough for self-service setup after time away.
  </action>
  <verify>
1. README.md exists at project root
2. Contains agent-shell JSON config example
3. Contains Emacs elisp snippet
4. Links to TROUBLESHOOTING.md
  </verify>
  <done>README enables setup without external assistance, includes agent-shell config and Emacs snippet</done>
</task>

<task type="auto">
  <name>Task 3: Create TROUBLESHOOTING.md</name>
  <files>TROUBLESHOOTING.md</files>
  <action>
Create troubleshooting guide covering common failures:

1. **Emacs server not running**
   - Symptom: "can't find socket" or timeout
   - Check: `emacsclient -e "(+ 1 1)"` — should return `2`
   - Fix: Run `M-x server-start` in Emacs or add to init

2. **Socket path issues**
   - Symptom: "socket directory" errors
   - Check: `ls ~/.emacs.d/server/` (or `$TMPDIR/emacs$(id -u)/`)
   - Fix: Ensure `server-socket-dir` is correct, check permissions

3. **Function not defined (void-function)**
   - Symptom: Warning in *Messages* about fallback
   - Check: `M-: (fboundp 'mr-x/ask-user-question)` — should return `t`
   - Fix: Verify load-file path in Emacs config, eval the file

4. **Permission denied**
   - Symptom: Error mentions permissions
   - Check: `ls -la ~/.emacs.d/server/`
   - Fix: `chmod 700 ~/.emacs.d/server/`

5. **Timeout issues**
   - Symptom: "timed out after X seconds"
   - Check: Is the question being displayed? Is Emacs responsive?
   - Fix: Increase `timeout_ms` parameter, check Emacs isn't hung

6. **Command not found (emacsclient)**
   - Symptom: "command not found" error
   - Check: `which emacsclient`
   - Fix: Install Emacs or add to PATH

Each section: symptom, diagnostic command, fix.
  </action>
  <verify>
1. TROUBLESHOOTING.md exists at project root
2. Contains sections for all major failure modes
3. Each section has symptom, diagnostic, and fix
  </verify>
  <done>Troubleshooting guide covers Emacs server down, socket issues, function not defined, permissions, timeouts</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. `LOG_LEVEL=debug node build/index.js` shows Q&A logs on interaction
3. README.md and TROUBLESHOOTING.md exist with complete content
4. Config snippets are copy-paste ready (except path replacement)
</verification>

<success_criteria>
- Q&A audit logs include question, response, duration, success at debug level
- README has working agent-shell JSON config example
- README has working Emacs elisp snippet
- Troubleshooting covers: server not running, socket issues, function not defined, permissions, timeouts
- All documentation uses absolute path placeholders
</success_criteria>

<output>
After completion, create `.planning/phases/03-emacs-ux-production-hardening/03-02-SUMMARY.md`
</output>
