---
phase: 02-error-handling-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/logger.ts
  - src/index.ts
  - src/emacs-interface.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Server logs JSON to stderr with level, message, timestamp"
    - "Server terminates gracefully on SIGINT/SIGTERM"
    - "Active emacsclient processes are killed on shutdown"
    - "Logs appear for shutdown and process termination"
  artifacts:
    - path: "src/logger.ts"
      provides: "Pino logger instance"
      exports: ["logger", "default"]
    - path: "src/index.ts"
      provides: "Signal handlers with cleanup"
      contains: "process.on.*SIGINT"
    - path: "src/emacs-interface.ts"
      provides: "Process tracking via trackProcess()"
      exports: ["trackProcess", "askViaEmacs"]
  key_links:
    - from: "src/index.ts"
      to: "src/logger.ts"
      via: "import logger"
      pattern: "import.*logger"
    - from: "src/emacs-interface.ts"
      to: "src/logger.ts"
      via: "import logger"
      pattern: "import.*logger"
    - from: "src/index.ts"
      to: "src/emacs-interface.ts"
      via: "import trackProcess for signal handler"
      pattern: "import.*activeProcesses|trackProcess"
---

<objective>
Set up structured logging infrastructure and graceful shutdown handling for the MCP server.

Purpose: Provides observability via Pino JSON logs and ensures child processes are cleaned up on termination (prevents zombie emacsclient processes).

Output: Working logger module, signal handlers that kill active processes, and process tracking in emacs-interface.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-error-handling-reliability/02-CONTEXT.md
@.planning/phases/02-error-handling-reliability/02-RESEARCH.md
@src/index.ts
@src/emacs-interface.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Pino and create logger module</name>
  <files>package.json, src/logger.ts</files>
  <action>
Install pino and pino-pretty (dev dependency):
```bash
npm install pino
npm install --save-dev pino-pretty
```

Create `src/logger.ts` with:
- Import pino
- Configure logger instance:
  - level: `process.env.LOG_LEVEL || 'info'`
  - Output to stderr (Pino default, but be explicit)
  - formatters.level to output level as string label (not number)
- Export logger as default and named export
- Do NOT enable pino-pretty transport in code (use `npm run dev | pino-pretty` pattern instead for simplicity)

Example structure:
```typescript
import pino from 'pino';

export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  formatters: {
    level: (label) => ({ level: label })
  }
});

export default logger;
```
  </action>
  <verify>
- `npm run build` compiles without errors
- `grep "pino" package.json` shows pino in dependencies
- `ls src/logger.ts` exists
  </verify>
  <done>Logger module exists, exports logger instance, build succeeds</done>
</task>

<task type="auto">
  <name>Task 2: Add signal handlers and process tracking</name>
  <files>src/emacs-interface.ts, src/index.ts</files>
  <action>
**Modify `src/emacs-interface.ts`:**

1. Import logger: `import logger from './logger.js';`
2. Create a Set to track active child processes:
   ```typescript
   const activeProcesses = new Set<ChildProcess>();
   ```
3. Export function to get active processes (for signal handler):
   ```typescript
   export function getActiveProcesses(): Set<ChildProcess> {
     return activeProcesses;
   }
   ```
4. After spawning emacsclient, add process to Set:
   ```typescript
   activeProcesses.add(proc);
   ```
5. On process exit (in 'close' handler), remove from Set:
   ```typescript
   proc.on('close', () => activeProcesses.delete(proc));
   ```
6. Replace console.error with logger calls where appropriate

**Modify `src/index.ts`:**

1. Import logger: `import logger from './logger.js';`
2. Import getActiveProcesses: `import { askViaEmacs, getActiveProcesses } from './emacs-interface.js';`
3. Add gracefulShutdown function BEFORE main():
   ```typescript
   function gracefulShutdown(signal: string): void {
     const processes = getActiveProcesses();
     logger.info({ signal, activeCount: processes.size }, 'Shutting down');
     
     for (const proc of processes) {
       if (!proc.killed) {
         logger.info({ pid: proc.pid }, 'Terminated pending emacsclient process');
         proc.kill('SIGTERM');
       }
     }
     
     process.exitCode = 0;
   }
   ```
4. Install signal handlers after server.connect():
   ```typescript
   process.on('SIGINT', () => gracefulShutdown('SIGINT'));
   process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
   ```
5. Replace console.error with logger calls:
   - "Ask User MCP Server running on stdio" -> logger.info
   - "Fatal error in main()" -> logger.error with { err: error }
  </action>
  <verify>
- `npm run build` compiles without errors
- `grep -r "SIGINT" src/` shows signal handler
- `grep -r "activeProcesses" src/emacs-interface.ts` shows tracking Set
- `grep -r "logger.info" src/index.ts` shows logger usage
  </verify>
  <done>
Signal handlers installed, child process tracking works, logs emit JSON to stderr
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   ```bash
   npm run build
   # Should compile without errors
   ```

2. Logger output verification:
   ```bash
   echo '{}' | node build/index.js 2>&1 | head -1
   # Should show JSON log line with "level":"info" and "Ask User MCP Server running"
   ```

3. Signal handler verification:
   ```bash
   # Start server in background, send SIGTERM, check logs
   node build/index.js &
   PID=$!
   sleep 0.5
   kill -TERM $PID
   # Should see "Shutting down" log message
   ```
</verification>

<success_criteria>
- Pino installed and logger module created
- Server logs JSON to stderr (not stdout)
- SIGINT/SIGTERM handlers installed
- Active processes tracked and killed on shutdown
- Build compiles cleanly
- Requirements addressed: ERR-03, ERR-04
</success_criteria>

<output>
After completion, create `.planning/phases/02-error-handling-reliability/02-01-SUMMARY.md`
</output>
